<!-- eslint-disable @angular-eslint/template/interactive-supports-focus -->

<div class="container-fluid">
    <app-page-title title="File Manager" [breadcrumbItems]="breadCrumbItems"></app-page-title>
   
    <div class="d-xl-flex">
        <div class="w-100">
            <div class="d-md-flex">
                <div class="card filemanager-sidebar me-md-2">
                    <div class="card-body">

                        <div class="d-flex flex-column h-100">
                            <div class="mb-4">
                                <div class="mb-3">
                                    <div class="dropdown" dropdown>
                                        <button class="btn btn-light dropdown-toggle w-100" dropdownToggle type="button" (click)="openCreateFolderModal()" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                            <i class="mdi mdi-plus me-1"></i> Create New Folder
                                        </button>
                                        <!-- <div class="dropdown-menu" *dropdownMenu>
                                            <a class="dropdown-item" href="javascript: void(0);" (click)="openCreateFolderModal()"><i class="bx bx-folder me-1"></i> Folder</a>
                                            <a class="dropdown-item" href="javascript: void(0);"><i class="bx bx-file me-1"></i> File</a> -->
                                      <!--  </div> -->
                                    </div>
                                </div>
                                <ul class="list-unstyled categories-list">
                                    <li>
                                        <div class="custom-accordion">
                                            <a class="text-body fw-medium py-1 d-flex align-items-center"  (click)="_ClickRootFolder()" (keydown.enter)="_ClickRootFolder()" (keydown.space)="_ClickRootFolder()" [attr.aria-expanded]="!isCollapsed" data-toggle="collapse" href="javascript:void(0);" role="button" aria-expanded="false" aria-controls="categories-collapse">
                                                <i class="mdi mdi-folder font-size-16 text-warning me-2"></i> My Files <i class="mdi mdi-chevron-up accor-down-icon ms-auto"></i>
                                            </a>
                                            <div  class="collapse show" id="categories-collapse" [collapse]="isCollapsed">
                                                <div class="card border-0 shadow-none ps-2 mb-0">
                                                    <ul class="list-unstyled mb-0">
                                                        <ng-container *ngTemplateOutlet="folderTreeTemplate; context: { $implicit: folderTree }"></ng-container>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    
                                    <li>
                                        <a href="javascript: void(0);" class="text-body d-flex align-items-center">
                                            <i class="mdi mdi-share-variant font-size-16 me-2"></i> <span class="me-auto">Shared</span> <i class="mdi mdi-circle-medium text-danger ms-2"></i>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript: void(0);" class="text-body d-flex align-items-center">
                                            <i class="mdi mdi-star-outline text-muted font-size-16 me-2"></i> <span class="me-auto">Starred</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript: void(0);" class="text-body d-flex align-items-center">
                                            <i class="mdi mdi-trash-can text-danger font-size-16 me-2"></i> <span class="me-auto">Trash</span>
                                        </a>
                                    </li>
                                    
                                </ul>
                            </div>
                            <div class="mt-auto">
                                <div class="text-center">
                                    <h5 class="font-size-15 mb-4">Storage</h5>
                                    <!-- <div class="apex-charts" id="radial-chart"></div> -->
                                    <apx-chart dir="ltr" class="apex-charts" [chart]="radialoptions.chart" [series]="radialoptions.series" [labels]="radialoptions.labels" [colors]="radialoptions.colors" [grid]="radialoptions.grid" [plotOptions]="radialoptions.plotOptions" [stroke]="radialoptions.stroke">
                                    </apx-chart>
                
                                    <p class="text-muted mt-4">{{storageQuota?.size}} of {{storageQuota?.storageLimit}} used</p>
                                </div>


                            </div>
                            
                        </div>

                    </div>
                </div>
                <!-- filemanager-leftsidebar -->

                <div class="w-100">
                    <div class="card">
                        <div class="card-body">
                            <div>
                                <div class="row mb-3">
                                    <div class="col-xl-3 col-sm-6">
                                        <div class="mt-2">
                                            <div class="d-flex align-items-center">
                                                <button *ngIf="showBackButton" 
                                                        class="btn btn-link p-0 me-2"
                                                        (click)="navigateToParent()">
                                                    <i class="mdi mdi-arrow-left font-size-20"></i>
                                                </button>
                                                <h5 class="mb-0">
                                                    {{ currentPath ? currentPath.split('/').pop() : 'My Files' }}
                                                </h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-9 col-sm-6">
                                        <form class="mt-4 mt-sm-0 float-sm-end d-flex align-items-center">
                                            <div class="search-box mb-2 me-2">
                                                <div class="position-relative">
                                                    <input type="text" class="form-control bg-light border-light rounded" placeholder="Search...">
                                                    <i class="bx bx-search-alt search-icon"></i>
                                                </div>
                                            </div>

                                            <div class="dropdown mb-0" dropdown>
                                                <a class="btn btn-link text-muted dropdown-toggle mt-n2" dropdownToggle role="button" data-toggle="dropdown" aria-haspopup="true">
                                                    <i class="mdi mdi-dots-vertical font-size-20"></i>
                                                </a>

                                                <div class="dropdown-menu dropdown-menu-end" *dropdownMenu>
                                                    <a class="dropdown-item" href="javascript: void(0);" (click)="openCreateFolderModal()">Create Folder</a>

                                                    <a class="dropdown-item" href="javascript: void(0);" (click)="openFileUploadModal()">Upload Files</a>
                                                    <!-- <a class="dropdown-item" href="javascript: void(0);">Share Files</a>
                                                    <a class="dropdown-item" href="javascript: void(0);">Share with me</a>
                                                    <a class="dropdown-item" href="javascript: void(0);">Other Actions</a> -->
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="scrollable-container">
                                <div *ngIf="folderList && folderList.length > 0" class="row">
                                    <div *ngFor="let folder of folderList" class="col-xl-3 col-sm-6">
                                        <div class="card shadow-none border" 
                                             [class.bg-light]="folder.isSelected"
                                               >
                                            <div class="card-body p-3">
                                                <div >
                                                    <div class="float-end ms-2">
                                                        <div class="dropdown mb-2" dropdown #dropdownRef="bs-dropdown">
                                                            <a class="font-size-16 text-muted dropdown-toggle" dropdownToggle role="button">
                                                                <i class="mdi mdi-dots-horizontal"></i>
                                                            </a>
                                                            <div class="dropdown-menu dropdown-menu-end" *dropdownMenu>
                                                                <a class="dropdown-item" 
                                                                   (click)="openFileUploadModal(folder)"
                                                                   (keydown.enter)="openFileUploadModal(folder)"
                                                                   (keydown.space)="openFileUploadModal(folder)"
                                                                   tabindex="0"
                                                                   role="button">
                                                                   <i class="mdi mdi-upload me-2"></i>Upload Files
                                                                </a>
                                                                <a class="dropdown-item" 
                                                                   (click)="selectFolder(folder, $event)"
                                                                   (keydown.enter)="selectFolder(folder)"
                                                                   (keydown.space)="selectFolder(folder)"
                                                                   tabindex="0"
                                                                   role="button">
                                                                    <i class="mdi mdi-folder-open me-2"></i>Open
                                                                </a>
                                                                <a class="dropdown-item" 
                                                                   (click)="renameItem(folder, $event, dropdownRef,true)"
                                                                   (keydown.enter)="renameItem(folder,dropdownRef, true)"
                                                                   (keydown.space)="renameItem(folder,dropdownRef, true)"
                                                                   (keyup.escape)="cancelRename($event)"

                                                                   tabindex="0"
                                                                   role="button">
                                                                    <i class="mdi mdi-pencil me-2"></i>Rename
                                                                </a>
                                                                <div class="dropdown-divider"></div>
                                                                <a class="dropdown-item text-danger" 
                                                                   (click)="deleteItem(folder, $event)"
                                                                   (keydown.enter)="deleteItem(folder)"
                                                                   (keydown.space)="deleteItem(folder)"
                                                                   tabindex="0"
                                                                   role="button">
                                                                    <i class="mdi mdi-delete me-2"></i>Delete
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="avatar-xs me-3 mb-3">
                                                        <div class="avatar-title bg-transparent rounded">
                                                            <i class="bx bxs-folder font-size-24 text-warning"></i>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex">
                                                        <div class="overflow-hidden me-auto">
                                                            <h5 class="font-size-14 text-truncate mb-1">
                                                                <ng-container *ngIf="isRenamingFolder && editingFolder?.path === folder.path; else displayMode">
                                                                    <input 
                                                                      id="rename-input-view"
                                                                      type="text" 
                                                                      [value]="editingName"
                                                                      (input)="editingName = renameInputView.value"
                                                                      (click)="$event.stopPropagation()"
                                                                      (keyup.enter)="renameItemConfirmed(folder, editingName, $event, true)"
                                                                      (keyup.escape)="cancelRename($event)"
                                                                      (blur)="renameItemConfirmed(folder, editingName, $event, true)"
                                                                      #renameInputView

                                                                    />
                                                                  </ng-container>
                                                                  <ng-template #displayMode>
                                                                    <a class="text-body" (click)="selectFolder(folder, $event)" style="cursor: pointer;">{{folder?.name}}</a>
                                                                  </ng-template>
                                                                <!-- <a class="text-body" (click)="selectFolder(folder, $event)" style="cursor: pointer;">{{folder?.name}}</a> -->
                                                            </h5>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- end col -->

                                </div>
                                
                                <div *ngIf="fileList && fileList.length > 0" class="row">
                                    <div *ngFor="let file of fileList" class="col-xl-3 col-sm-6">
                                        <div class="card shadow-none border">
                                            <div class="card-body p-3">
                                                <div class="">
                                                    <div class="float-end ms-2">
                                                        <div class="dropdown mb-2" dropdown #dropdownRef="bs-dropdown">
                                                            <a class="font-size-16 text-muted dropdown-toggle" dropdownToggle role="button">
                                                                <i class="mdi mdi-dots-horizontal"></i>
                                                            </a>
                                                            <div class="dropdown-menu dropdown-menu-end" *dropdownMenu>
                                                                <a class="dropdown-item" 
                                                                   (click)="openItem(file, $event)"
                                                                   (keydown.enter)="openItem(file)"
                                                                   (keydown.space)="openItem(file)"
                                                                   tabindex="0"
                                                                   role="button">
                                                                    <i class="mdi mdi-eye me-2"></i>Open
                                                                </a>
                                                                <div class="dropdown-divider"></div>
                                                                <a class="dropdown-item" 
                                                                   (click)="renameItem(file, $event, dropdownRef,true)"
                                                                   (keydown.enter)="renameItem(file,dropdownRef, true)"
                                                                   (keydown.space)="renameItem(file,dropdownRef, true)"
                                                                   (keyup.escape)="cancelRename($event)"
                                                                   tabindex="0"
                                                                   role="button">
                                                                    <i class="mdi mdi-pencil me-2"></i>Rename
                                                                </a>
                                                                <div class="dropdown-divider"></div>
                                                                <a class="dropdown-item text-danger" 
                                                                   (click)="deleteItem(file, $event)"
                                                                   (keydown.enter)="deleteItem(file)"
                                                                   (keydown.space)="deleteItem(file)"
                                                                   tabindex="0"
                                                                   role="button">
                                                                    <i class="mdi mdi-delete me-2"></i>Delete
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="avatar-xs me-3 mb-3">
                                                        <div class="avatar-title bg-transparent rounded">
                                                            <i class="bx bx-file font-size-24 text-info"></i>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex">
                                                        <div class="overflow-hidden me-auto">
                                                            <h5 class="font-size-14 text-truncate mb-1">
                                                                <ng-container *ngIf="isRenamingFile && editingFile?.name === file.name; else displayFileMode">
                                                                    <input 
                                                                      id="rename-file-view"
                                                                      type="text" 
                                                                      [value]="editingName"
                                                                      (input)="editingName = renameFileView.value"
                                                                      (click)="$event.stopPropagation()"
                                                                      (keyup.enter)="renameItemConfirmed(file, editingName, $event, true)"
                                                                      (keyup.escape)="cancelRename($event)"
                                                                      (blur)="renameItemConfirmed(file, editingName, $event, true)"
                                                                      #renameFileView

                                                                    />
                                                                  </ng-container>
                                                                  <ng-template #displayFileMode>
                                                                    <a class="text-body" (click)="openFile(file, $event)" style="cursor: pointer;">{{file?.name}}</a>
                                                                  </ng-template>                                                            </h5>
                                                            <p class="text-muted font-size-13 mb-0">{{file?.size | number}} bytes • {{file?.lastModified}}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- end row -->
                            </div>
                            <div class="mt-4">
                                <div class="d-flex flex-wrap">
                                    <h5 class="font-size-16 me-3">Recent Files</h5>

                                    <div class="ms-auto">
                                        <a href="javascript: void(0);" class="fw-medium text-reset">View All</a>
                                    </div>
                                </div>
                                <hr class="mt-2">

                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table align-middle table-nowrap table-hover mb-0">
                                        <thead>
                                            <tr>
                                                <th scope="col">Name</th>
                                                <th scope="col">Date modified</th>
                                                <th scope="col" colspan="2">Size</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @for(data of Recentfile;track $index){
                                            <tr>
                                                <td><a href="javascript: void(0);" class="text-dark fw-medium">
                                                        <i class="{{data.icon}} font-size-16 align-middle text-primary me-2"></i>{{data.name}}</a></td>
                                                <td>{{data.updatedAt | date:'short'}}</td>
                                                <td>{{ (data.size / 1024).toFixed(2) }} KB</td>
                                                <td>
                                                    <div class="dropdown" dropdown>
                                                        <a class="font-size-16 text-muted dropdown-toggle" role="button" dropdownToggle data-toggle="dropdown" aria-haspopup="true">
                                                            <i class="mdi mdi-dots-horizontal"></i>
                                                        </a>

                                                        <div class="dropdown-menu dropdown-menu-end" *dropdownMenu>
                                                            <a class="dropdown-item" href="javascript: void(0);">{{Open}}</a>
                                                           
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        
                    </div>
                    <!-- end card -->
                </div>
                <!-- end w-100 -->
            </div>
        </div>

        <!-- <div class="card filemanager-sidebar ms-lg-2">
            <div class="card-body">
                <div class="text-center">
                    <h5 class="font-size-15 mb-4">Storage</h5>
                    <!-- <div class="apex-charts" id="radial-chart"></div> -->
                    <!-- <apx-chart dir="ltr" class="apex-charts" [chart]="radialoptions.chart" [series]="radialoptions.series" [labels]="radialoptions.labels" [colors]="radialoptions.colors" [grid]="radialoptions.grid" [plotOptions]="radialoptions.plotOptions" [stroke]="radialoptions.stroke">
                    </apx-chart>

                    <p class="text-muted mt-4">{{storageQuota?.size}} of {{storageQuota?.storageLimit}} used</p>
                </div>

                <div class="mt-4">
                    <div class="card border shadow-none mb-2">
                        <a href="javascript: void(0);" class="text-body">
                            <div class="p-2">
                                <div class="d-flex">
                                    <div class="avatar-xs align-self-center me-2">
                                        <div class="avatar-title rounded bg-transparent text-success font-size-20">
                                            <i class="mdi mdi-image"></i>
                                        </div>
                                    </div>

                                    <div class="overflow-hidden me-auto">
                                        <h5 class="font-size-13 text-truncate mb-1">Images</h5>
                                        <p class="text-muted text-truncate mb-0">176 Files</p>
                                    </div>

                                    <div class="ms-2">
                                        <p class="text-muted">6 GB</p>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="card border shadow-none mb-2">
                        <a href="javascript: void(0);" class="text-body">
                            <div class="p-2">
                                <div class="d-flex">
                                    <div class="avatar-xs align-self-center me-2">
                                        <div class="avatar-title rounded bg-transparent text-danger font-size-20">
                                            <i class="mdi mdi-play-circle-outline"></i>
                                        </div>
                                    </div>

                                    <div class="overflow-hidden me-auto">
                                        <h5 class="font-size-13 text-truncate mb-1">Video</h5>
                                        <p class="text-muted text-truncate mb-0">45 Files</p>
                                    </div>

                                    <div class="ms-2">
                                        <p class="text-muted">4.1 GB</p>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="card border shadow-none mb-2">
                        <a href="javascript: void(0);" class="text-body">
                            <div class="p-2">
                                <div class="d-flex">
                                    <div class="avatar-xs align-self-center me-2">
                                        <div class="avatar-title rounded bg-transparent text-info font-size-20">
                                            <i class="mdi mdi-music"></i>
                                        </div>
                                    </div>

                                    <div class="overflow-hidden me-auto">
                                        <h5 class="font-size-13 text-truncate mb-1">Music</h5>
                                        <p class="text-muted text-truncate mb-0">21 Files</p>
                                    </div>

                                    <div class="ms-2">
                                        <p class="text-muted">3.2 GB</p>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="card border shadow-none mb-2">
                        <a href="javascript: void(0);" class="text-body">
                            <div class="p-2">
                                <div class="d-flex">
                                    <div class="avatar-xs align-self-center me-2">
                                        <div class="avatar-title rounded bg-transparent text-primary font-size-20">
                                            <i class="mdi mdi-file-document"></i>
                                        </div>
                                    </div>

                                    <div class="overflow-hidden me-auto">
                                        <h5 class="font-size-13 text-truncate mb-1">Document</h5>
                                        <p class="text-muted text-truncate mb-0">21 Files</p>
                                    </div>

                                    <div class="ms-2">
                                        <p class="text-muted">2 GB</p>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>

                    <div class="card border shadow-none">
                        <a href="javascript: void(0);" class="text-body">
                            <div class="p-2">
                                <div class="d-flex">
                                    <div class="avatar-xs align-self-center me-2">
                                        <div class="avatar-title rounded bg-transparent text-warning font-size-20">
                                            <i class="mdi mdi-folder"></i>
                                        </div>
                                    </div>

                                    <div class="overflow-hidden me-auto">
                                        <h5 class="font-size-13 text-truncate mb-1">Others</h5>
                                        <p class="text-muted text-truncate mb-0">20 Files</p>
                                    </div>

                                    <div class="ms-2">
                                        <p class="text-muted">1.4 GB</p>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div> -->
   <!-- </div> -->
    <!-- end row -->
</div>

<!-- File Upload Modal -->
<div class="modal" tabindex="-1" role="dialog" [ngClass]="{'show': isFileUploadModalOpen}" [style.display]="isFileUploadModalOpen ? 'block' : 'none'">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Files</h5>
                <button type="button" class="btn-close" (click)="closeFileUploadModal()"></button>
            </div>
            <div class="modal-body">
                <!-- Drag and Drop Zone -->
                <div class="upload-zone p-4 text-center border rounded" 
                     [ngClass]="{'dragging': isDragging}"
                     (dragover)="onDragOver($event)"
                     (dragleave)="onDragLeave($event)"
                     (drop)="onDrop($event)">
                    <i class="mdi mdi-cloud-upload font-size-24 text-primary mb-2"></i>
                    <h5>Drag and drop files here</h5>
                    <p class="text-muted">or</p>
                    <div class="mt-2">
                        <input type="file" 
                               #fileInput 
                               multiple 
                               class="d-none" 
                               (change)="onFileSelected($event)">
                        <button type="button" 
                                class="btn btn-primary" 
                                (click)="fileInput.click()">
                            Browse Files
                        </button>
                    </div>
                </div>

                <!-- Selected Files List -->
                <div class="selected-files mt-4" *ngIf="selectedFiles.length > 0">
                    <h6>Selected Files:</h6>
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between align-items-center" 
                             *ngFor="let file of selectedFiles; let i = index">
                            <div>
                                <i class="mdi mdi-file me-2"></i>
                                {{ file.name }}
                                <small class="text-muted ms-2">{{ (file.size / 1024).toFixed(2) }} KB</small>
                            </div>
                            <button type="button" 
                                    class="btn btn-link text-danger p-0" 
                                    (click)="removeFile(i)">
                                <i class="mdi mdi-close"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" 
                        class="btn btn-light" 
                        (click)="closeFileUploadModal()">
                    Cancel
                </button>
                <button type="button" 
                        class="btn btn-primary" 
                        [disabled]="selectedFiles.length === 0"
                        (click)="uploadFiles()">
                    Upload Files
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="isFileUploadModalOpen"></div>

<div class="modal" tabindex="-1" role="dialog" [ngClass]="{'show': isCreateFolderModalOpen}" [style.display]="isCreateFolderModalOpen ? 'block' : 'none'">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title mt-0">Create New Folder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" (click)="closeCreateFolderModal()">
            </button>
        </div>
        
        <div class="modal-body">
            <input
            type="text"
            class="form-control"
            placeholder="Enter folder name"
            [formControl]="folderNameControl"
            (focus)="moveCursorToEnd()"
          />        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeCreateFolderModal()">Close</button>
          <button type="button" class="btn btn-primary" (click)="createFolder()">Create</button>
        </div>
      </div>
    </div>
  </div>

<!-- Replace the existing folderTreeTemplate with this updated version -->
<ng-template #folderTreeTemplate let-folders>
    <li *ngFor="let folder of folders.folders">
        <div class="d-flex align-items-center folder-item" [class.bg-light]="folder.isSelected">
            <a (click)="fetchFolders(folder, $event)" 
               (keydown.enter)="fetchFolders(folder)" 
               (keydown.space)="fetchFolders(folder)" 
               tabindex="0" 
               role="button" 
               class="d-flex align-items-center flex-grow-1">
                <div class="folder-name-container">
                    <i class="mdi mdi-folder me-2" 
                       [class.text-warning]="!folder.isSelected"
                       [class.text-primary]="folder.isSelected"
                       ></i>
                    <ng-container *ngIf="!isRenamingFolder || editingFolder?.path !== folder.path">
                        <span class="font-size-12 me-auto">{{folder.name}}</span>
                    </ng-container>
                    <ng-container *ngIf="isRenamingFolder && editingFolder?.path === folder.path">
                        <input
                            #renameInput
                            id="rename-input"
                            type="text"
                            class="form-control form-control-sm"
                            [value]="editingName"
                            (input)="editingName = renameInput.value"
                            (click)="$event.stopPropagation()"
                            (keyup.enter)="renameItemConfirmed(folder, editingName, $event)"
                            (keyup.escape)="cancelRename($event)"
                            (blur)="renameItemConfirmed(folder, editingName, $event)"
                        />
                    </ng-container>
                </div>
                <div class="folder-actions ms-auto me-2">
                    <button class="btn btn-link text-muted p-1" 
                            (click)="renameItem(folder, $event, false)"
                            (keydown.enter)="renameItem(folder, false)"
                            (keydown.space)="renameItem(folder, false)"
                            tabindex="0">
                        <i class="mdi mdi-pencil"></i>
                    </button>
                    <button class="btn btn-link text-danger p-1" 
                            (click)="deleteItem(folder, $event)"
                            (keydown.enter)="deleteItem(folder, false)"
                            (keydown.space)="deleteItem(folder)"
                            tabindex="0">
                        <i class="mdi mdi-delete"></i>
                    </button>
                </div>
                <i *ngIf="folder.subFolders?.length || folder.files?.length || !folder.isExpanded" 
                   class="mdi" 
                   [class.mdi-chevron-down]="folder.isExpanded"
                   [class.mdi-chevron-right]="!folder.isExpanded"
                   (click)="toggleFolder(folder, $event)"
                   (keydown.enter)="toggleFolder(folder, $event)"
                   (keydown.space)="toggleFolder(folder, $event)"
                   tabindex="0"
                   role="button">
                                      

                </i>
            </a>
        </div>
        
        <div class="ms-4" *ngIf="folder.isExpanded">
            <ul class="list-unstyled mb-0">
                <ng-container *ngIf="folder.subFolders?.length">
                    <ng-container *ngTemplateOutlet="folderTreeTemplate; context: { $implicit: folder.subFolders }">
                    </ng-container>
                </ng-container>
                
                <li *ngFor="let file of folder.files" class="file-item">
                    <div class="d-flex align-items-center">
                        <div class="file-name-container">
                            <ng-container *ngIf="!isRenamingFile || editingFile?.name !== file.name">
                                <i class="mdi mdi-file-document font-size-13 text-primary me-2"></i>
                                <span class="font-size-12">{{file.name}}</span>
                            </ng-container>
                            <ng-container *ngIf="isRenamingFile && editingFile?.name === file.name">
                                <input
                                    #renamesubFileInput
                                    id="rename-file-input"
                                    type="text"
                                    class="form-control form-control-sm"
                                    [value]="editingName"
                                    (input)="editingName = renamesubFileInput.value"
                                    (click)="$event.stopPropagation()"
                                    (keyup.enter)="renameItemConfirmed(file, editingName, $event)"
                                    (keyup.escape)="cancelRename($event)"
                                    (blur)="renameItemConfirmed(file, editingName, $event)"
                                />
                            </ng-container>
                        </div>
                        <div class="file-actions ms-auto">
                            <button class="btn btn-link text-muted p-1" 
                                    (click)="renameItem(file, $event)"
                                    (keydown.enter)="renameItem(file, false)"
                                    (keydown.space)="renameItem(file, false)"
                                    tabindex="0"
                                    title="Rename">
                                <i class="mdi mdi-pencil"></i>
                            </button>
                            <button class="btn btn-link text-danger p-1" 
                                    (click)="deleteItem(file, $event)"
                                    title="Delete">
                                <i class="mdi mdi-delete"></i>
                            </button>
                        </div>
                    </div>
                </li>
            </ul>
        </div>
    </li>
    <li *ngFor="let file of folders.files" class="file-item">
        <div class="d-flex align-items-center">
            <div class="file-name-container">
                <ng-container *ngIf="!isRenamingFile || editingFile?.name !== file.name">
                    <i class="mdi mdi-file-document font-size-13 text-primary me-2"></i>
                    <span class="font-size-12">{{file.name}}</span>
                </ng-container>
                <ng-container *ngIf="isRenamingFile && editingFile?.name === file.name">
                    <input
                        #renameFileInput
                        id="rename-file-input"
                        type="text"
                        class="form-control form-control-sm"
                        [value]="editingName"
                        (input)="editingName = renameFileInput.value"
                        (click)="$event.stopPropagation()"
                        (keyup.enter)="renameItemConfirmed(file, editingName, $event)"
                        (keyup.escape)="cancelRename($event)"
                        (blur)="renameItemConfirmed(file, editingName, $event)"
                    />
                </ng-container>
            </div>
            <div class="file-actions ms-auto">
                <button class="btn btn-link text-muted p-1" 
                        (click)="renameItem(file, $event)"
                        (keydown.enter)="renameItem(file, false)"
                        (keydown.space)="renameItem(file, false)"
                        tabindex="0"
                        title="Rename">
                    <i class="mdi mdi-pencil"></i>
                </button>
                <button class="btn btn-link text-danger p-1" 
                        (click)="deleteItem(file, $event)"
                        title="Delete">
                    <i class="mdi mdi-delete"></i>
                </button>
            </div>
        </div>
    </li>
</ng-template>
<div id="elmLoader" class="loader" *ngIf="loading$ | async">
    <div class="spinner-border text-primary avatar-sm" role="status">
      <span class="visually-hidden">{{'Loading...' | translate}}</span>
    </div>
  </div>  